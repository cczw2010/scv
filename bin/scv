#!/usr/bin/env node
'use strict';

process.bin = process.title = 'scv';

// 获取目录
var fs = require('fs');
var path = require('path');
var scvutil = require('../lib/scv-util.js');
var scvtemp = require('../lib/scv-template');
var scvPath = path.dirname(fs.realpathSync(__filename)) + "/../";
var workPath = process.cwd();
/**命令行子命令设置***************/
var program = require('commander');
program
  .version('1.0.0');

// 工程初始化
program.command('init [template]')
  // .alias('i')
  .description('根据模板初始化工程,请在空目录下执行该命令,工程默认模板为default')
  // .option('-f, --force','强制初始化，如果目录不为空将清空')
  .action(init);

program.command('server')
  .description('工程监控服务')
  .option('-i,--info','显示当前服务状态')
  .option('-s,--start','启动服务')
  .option('-S,--stop','停止服务')
  .option('-r,--restart','重启服务')
  .action(server);

program.command('release')
  .description('发布工程')
  .option('-l --list','显示已经发布的版本列表')
  .action(release);
program.command('template')
  .description('将当前工程保存为模板')
  .option('-l --list','显示当前模板列表')
  .option('-d --delete <name>','删除模板')
  .option('-s --save <name>','将当前开发目录保存为模板')
  .action(template);
  
program.parse(process.argv);

// 空参数输出帮助
if (!process.argv.slice(2).length) {
  program.outputHelp();
}
/**命令参数处理部分********************************/
process.on('message', function(m) {
  console.log('process got message:', m);
});
// 收到退出命令时，退出并停止子服务
process.on('SIGINT', function (){
  //停止gulp子进程
  var scvgulp = require('../lib/scv-gulp');
  scvgulp.stop();
  process.kill();
});
// 初始化工程
function init(tempName){
  if (scvutil.checkSCV(workPath)) {
    console.log('[scv] 工程目录不为空，无法初始化。');
    return;
  }
  var exec = require('child_process').exec;
  var commstr = 'ln -s '+scvPath+'node_modules/ '+workPath+'/node_modules;';
  commstr+='ln -s '+scvPath+'lib/gulpfile.js '+workPath+'/gulpfile.js;';
  exec(commstr,function(error, stdout, stderr){
    if (error !== null) {
      console.log('[scv] error: ' + error);
      return;
    }
  });

  console.log('[scv] 工程初始化...');
  scvtemp.copy(tempName,workPath);
}
function server(){
  if (!scvutil.checkSCV(workPath)) {
    console.log('[scv] 不是有效的scv工程目录。'+workPath);
    return;
  }

  var args = Array.prototype.slice.bind(arguments)();
  // console.log(args);
  var options= args.pop();

  var scvgulp = require('../lib/scv-gulp');
  // 当前启动状态
  if (options.info) {
    scvgulp.info();
    return;
  }
  // 启动
  if (options.start) {
    scvgulp.start(workPath);
    return;
  }

  if (options.restart) {
    scvgulp.reStart();
    return;
  }

  if (options.stop) {
    scvgulp.stop();
    return;
  }
  this.outputHelp();
}

// 保存模板
function template(){
  var args = Array.prototype.slice.bind(arguments)();
  // console.log(args);
  var options= args.pop();
  // 列表
  if (options.list) {
    console.log('[scv] 模板列表：');
    scvtemp.list();
    return;
  }
  // 保存
  if (options.save) {
    var workPath = process.cwd();
    if (!scvutil.checkSCV(workPath)) {
      console.log('[scv] 当前目录不是有效地scv工程目录');
      return;
    }
    scvtemp.save(options.save,workPath);
    return;
  }
  // 删除
  if (options.delete) {
    var tempName = options.delete;
    scvtemp.del(tempName);
    return;
  }
  this.outputHelp();
}
// 发布版本
function release(){
  var args = Array.prototype.slice.bind(arguments)(),
    options= args.pop();
  // 列表
  if (options.list) {
    console.log('[scv] 已发布版本列表：');
    fs.readdir(scvutil.revSpace, function(err, paths) {
      if (err) {
        throw err;
      }
      paths.forEach(function(p) {
        fs.stat(path.join(scvutil.revSpace,p),function(err,stat){
          if (!err && stat.isDirectory(p)) {
            console.log('> '+p);
          }
        });
      });
    });
    return;
  }
  var scvgulp = require('../lib/scv-gulp');
  scvgulp.release(scvutil.revSpace);
}